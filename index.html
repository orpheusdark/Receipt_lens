<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Lens</title>
    <!-- Favicon using inline SVG -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%234f46e5' stroke='white' stroke-width='5'/><circle cx='50' cy='50' r='20' fill='white'/></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Load Google API scripts -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Animated Shapes Background */
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(300deg, #1e1b4b, #4c1d95, #0f172a);
            z-index: -1;
        }
        .shape {
            position: absolute;
            display: block;
            list-style: none;
            background: rgba(255, 255, 255, 0.05);
            animation: float 25s linear infinite;
            bottom: -200px; /* Start below the screen */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .shape.circle { border-radius: 50%; }
        .shape.square { border-radius: 0; }

        .shape:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .shape:nth-child(2){ left: 10%; width: 30px; height: 30px; animation-delay: 2s; animation-duration: 17s; }
        .shape:nth-child(3){ left: 70%; width: 25px; height: 25px; animation-delay: 4s; }
        .shape:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 22s; }
        .shape:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 1s; }
        .shape:nth-child(6){ left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .shape:nth-child(7){ left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .shape:nth-child(8){ left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .shape:nth-child(9){ left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .shape:nth-child(10){ left: 85%; width: 160px; height: 160px; animation-delay: 0s; animation-duration: 15s; }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-120vh) rotate(720deg); opacity: 0; }
        }
        #video-stream { width: 100%; height: 100%; object-fit: cover; }
        #file-input { display: none; }
        .btn-icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.75rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-1rem); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up {
            animation: fadeIn 0.6s ease-out forwards;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 sm:p-6">
    
    <div class="background-container">
        <div class="shape circle"></div><div class="shape square"></div><div class="shape circle"></div>
        <div class="shape square"></div><div class="shape circle"></div><div class="shape square"></div>
        <div class="shape circle"></div><div class="shape square"></div><div class="shape circle"></div>
        <div class="shape square"></div>
    </div>

    <div class="w-full max-w-md mx-auto bg-white/80 backdrop-blur-xl rounded-2xl shadow-2xl overflow-hidden fade-in-up">
        <!-- Header with Logo -->
        <div class="p-6 bg-gradient-to-br from-indigo-600 to-purple-700 text-white flex flex-col items-center justify-center space-y-2">
            <div class="flex items-center space-x-3">
                <svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="white" fill-opacity="0.2"/><circle cx="12" cy="12" r="6" fill="white"/><path d="M15 9C15 7.34315 13.6569 6 12 6C10.3431 6 9 7.34315 9 9" stroke="#6366F1" stroke-width="1.5" stroke-linecap="round"/></svg>
                <h1 class="text-2xl font-bold">Receipt Lens</h1>
            </div>
            <p class="text-center text-indigo-200 text-sm">Instant Expense Logging</p>
        </div>

        <!-- Display Area -->
        <div id="display-area" class="relative bg-gray-900 w-full" style="padding-top: 100%;">
            <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                <video id="video-stream" class="hidden rounded-lg" autoplay playsinline></video>
                <img id="captured-image" class="hidden w-full h-full object-contain rounded-lg" alt="Captured Receipt">
                <div id="placeholder" class="text-gray-500 text-center">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                     <p id="placeholder-text" class="mt-2 text-sm font-medium">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Controls Area -->
        <div class="p-6 bg-gray-50">
            <div id="status-message-wrapper" class="text-center text-sm font-medium mb-4 h-10 flex items-center justify-center p-2 rounded-lg transition-all duration-300"><p id="status-message"></p></div>
            
            <!-- This section is shown to new users who need to complete the setup -->
            <div id="config-section" class="hidden space-y-3">
                 <p id="auth-instructions" class="text-center text-gray-700"></p>
                 <button id="setup-btn" class="w-full flex items-center justify-center bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95">Complete One-Time Setup</button>
            </div>

            <!-- This section is shown after setup is complete but before sign-in -->
            <div id="auth-section" class="hidden space-y-3">
                 <button id="authorize-btn" class="w-full flex items-center justify-center bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95">Sign In & Authorize</button>
            </div>

            <!-- This section is shown after the user is fully authenticated -->
            <div id="initial-controls" class="hidden flex-col space-y-3"><button id="start-scan-btn" class="w-full flex items-center justify-center bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>Scan New Receipt</button></div>
            <div id="capture-controls" class="hidden flex flex-col space-y-3"><button id="capture-btn" class="w-full flex items-center justify-center bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /></svg>Capture Photo</button><button id="stop-scan-btn" class="w-full flex items-center justify-center bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-400 transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>Cancel</button></div>
            <div id="final-controls" class="hidden grid grid-cols-2 gap-3"><button id="retake-btn" class="w-full flex items-center justify-center bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-400 transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.695v-2.695" /></svg>Retake</button><button id="upload-btn" class="w-full flex items-center justify-center bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15m0-3l-3-3m0 0l-3 3m3-3v11.25" /></svg>Process & Save</button></div>
        </div>
    </div>
    <canvas id="canvas" class="hidden"></canvas>
    <script>
        // --- App Configuration ---
        let GOOGLE_API_CLIENT_ID = "";
        let GEMINI_API_KEY = "";
        let SPREADSHEET_ID = "";
        const SHEET_NAME = "Receipt";

        // --- Element References ---
        const video = document.getElementById('video-stream');
        const canvas = document.getElementById('canvas');
        const capturedImage = document.getElementById('captured-image');
        const placeholder = document.getElementById('placeholder');
        const placeholderText = document.getElementById('placeholder-text');
        const statusMessage = document.getElementById('status-message');
        const statusMessageWrapper = document.getElementById('status-message-wrapper');
        const configSection = document.getElementById('config-section');
        const authSection = document.getElementById('auth-section');
        const setupBtn = document.getElementById('setup-btn'); // <-- BUG FIX: This was missing
        const authorizeBtn = document.getElementById('authorize-btn');
        const initialControls = document.getElementById('initial-controls');
        const startScanBtn = document.getElementById('start-scan-btn');
        const captureControls = document.getElementById('capture-controls');
        const finalControls = document.getElementById('final-controls');
        const stopScanBtn = document.getElementById('stop-scan-btn');
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const uploadBtn = document.getElementById('upload-btn');

        let stream = null, gapiClient, tokenClient, isAuthenticated = false;

        // --- Initialization ---
        window.onload = () => {
            if (window.location.hash.startsWith('#credentials=')) {
                const encodedCreds = window.location.hash.substring('#credentials='.length);
                try {
                    const creds = JSON.parse(atob(encodedCreds));
                    localStorage.setItem('receiptLensCreds', JSON.stringify(creds));
                    window.location.hash = '';
                    window.location.reload();
                    return;
                } catch (e) {
                    console.error("Could not parse credentials from URL hash", e);
                }
            }
            
            loadCredentials();

            if (!GEMINI_API_KEY || !GOOGLE_API_CLIENT_ID || !SPREADSHEET_ID) {
                showSetupState();
            } else {
                gapi.load('client', initializeGapiClient);
            }
        };

        function loadCredentials() {
            const storedCreds = localStorage.getItem('receiptLensCreds');
            if (storedCreds) {
                const creds = JSON.parse(storedCreds);
                GOOGLE_API_CLIENT_ID = creds.clientId;
                GEMINI_API_KEY = creds.geminiKey;
                SPREADSHEET_ID = creds.sheetId;
            }
        }

        function showSetupState() {
            configSection.classList.remove('hidden');
            authInstructions.textContent = "Welcome! Please complete the one-time setup to begin.";
            placeholderText.textContent = "Setup Required";
            setupBtn.onclick = () => window.location.href = "./helper.html";
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
                gapiClient = gapi.client;
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_API_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/spreadsheets',
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            isAuthenticated = true;
                            updateUiToAuthorizedState();
                        }
                    },
                });
                tokenClient.requestAccessToken({ prompt: '' });
                
                setTimeout(() => {
                    if (!isAuthenticated) {
                        authSection.classList.remove('hidden');
                        placeholderText.textContent = "Please sign in.";
                    }
                }, 2000);

            } catch (error) {
                console.error("Error during initialization:", error);
                statusMessage.textContent = "Initialization failed.";
            }
        }

        authorizeBtn.addEventListener('click', () => {
            if (tokenClient) tokenClient.requestAccessToken({ prompt: 'consent' });
        });
        
        function updateUiToAuthorizedState() {
            authSection.classList.add('hidden');
            initialControls.classList.remove('hidden');
            statusMessage.textContent = "Ready to scan.";
            placeholderText.textContent = "Ready to scan a new receipt.";
        }

        function showState(state) {
            [initialControls, captureControls, finalControls, video, capturedImage].forEach(el => el.classList.add('hidden'));
            placeholder.classList.remove('hidden');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            switch (state) {
                case 'initial': initialControls.classList.remove('hidden'); statusMessage.textContent = 'Ready to scan.'; break;
                case 'scanning': captureControls.classList.remove('hidden'); video.classList.remove('hidden'); placeholder.classList.add('hidden'); startVideoStream(); break;
                case 'captured': finalControls.classList.remove('hidden'); capturedImage.classList.remove('hidden'); placeholder.classList.add('hidden'); statusMessage.textContent = 'Review image, then process.'; break;
            }
        }

        startScanBtn.addEventListener('click', () => showState('scanning'));
        stopScanBtn.addEventListener('click', () => showState('initial'));
        retakeBtn.addEventListener('click', () => showState('scanning'));
        captureBtn.addEventListener('click', capturePhoto);
        uploadBtn.addEventListener('click', processAndSave);

        async function startVideoStream() {
            statusMessage.textContent = 'Starting camera...';
            try {
                const constraints = { video: { facingMode: 'environment' } };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.onloadedmetadata = () => { statusMessage.textContent = 'Camera active.'; };
            } catch (err) {
                statusMessage.textContent = 'Camera access denied.';
                showState('initial');
            }
        }

        function capturePhoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            capturedImage.src = canvas.toDataURL('image/jpeg', 0.9);
            showState('captured');
        }

        async function processAndSave() {
            statusMessage.textContent = 'Analyzing with AI...';
            statusMessageWrapper.classList.add('bg-blue-100', 'text-blue-800');
            finalControls.classList.add('hidden');
            const base64ImageData = capturedImage.src.split(',')[1];
            try {
                const extractedData = await analyzeReceiptWithGemini(base64ImageData);
                statusMessage.textContent = 'Data extracted! Saving to sheet...';
                await appendToGoogleSheet(extractedData);
                statusMessageWrapper.classList.remove('bg-blue-100');
                statusMessageWrapper.classList.add('bg-green-100', 'text-green-800');
                statusMessage.textContent = '✅ Success! Saved to Google Sheets.';
            } catch (error) {
                statusMessageWrapper.classList.remove('bg-blue-100');
                statusMessageWrapper.classList.add('bg-red-100', 'text-red-800');
                statusMessage.textContent = `❌ Error: ${error.message}`;
            } finally {
                setTimeout(() => {
                    statusMessageWrapper.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                    showState('initial');
                }, 3000);
            }
        }

        async function analyzeReceiptWithGemini(base64ImageData) {
            const model = 'gemini-1.5-flash-latest';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
            const prompt = `Thoroughly analyze the receipt image and extract a detailed breakdown. Respond ONLY with a valid JSON object. For any value that cannot be found, use "N/A". The JSON object must have the following keys: vendor, transactionDate (YYYY-MM-DD), transactionTime, paymentType, subtotal, tax, grandTotal, and an array of items with description, quantity, and unitPrice.`;
            const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: 'image/jpeg', data: base64ImageData } }] }] };
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Gemini API Error: ${response.statusText}`);
            const result = await response.json();
            const jsonString = result.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            return JSON.parse(jsonString);
        }

        async function appendToGoogleSheet(data) {
            const photoTimestamp = new Date().toLocaleString();
            const transactionId = `TID-${Date.now()}`;
            const rows = [];
            if (data.items && data.items.length > 0) {
                data.items.forEach((item, index) => {
                    rows.push([
                        photoTimestamp, transactionId, data.vendor || 'N/A', data.transactionDate || 'N/A',
                        data.transactionTime || 'N/A', data.paymentType || 'N/A', item.description || 'N/A',
                        item.quantity || 1, item.unitPrice || 0.0,
                        index === 0 ? (data.subtotal || 0.0) : '',
                        index === 0 ? (data.tax || 0.0) : '',
                        index === 0 ? (data.grandTotal || 0.0) : ''
                    ]);
                });
            } else {
                rows.push([
                    photoTimestamp, transactionId, data.vendor || 'N/A', data.transactionDate || 'N/A',
                    data.transactionTime || 'N/A', data.paymentType || 'N/A', 'N/A', 'N/A', 'N/A',
                    data.subtotal || 0.0, data.tax || 0.0, data.grandTotal || 0.0
                ]);
            }
            const params = { spreadsheetId: SPREADSHEET_ID, range: `${SHEET_NAME}!A:L`, valueInputOption: 'USER_ENTERED', insertDataOption: 'INSERT_ROWS' };
            const valueRangeBody = { majorDimension: 'ROWS', values: rows };
            await gapiClient.sheets.spreadsheets.values.append(params, valueRangeBody);
        }
    </script>
</body>
</html>
